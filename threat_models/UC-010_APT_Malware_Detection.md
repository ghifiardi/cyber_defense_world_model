# UC-010: APT Malware Signature & Behaviour Detection
## Complete Threat Model & Detection Use Case

**Status:** Planned  
**Severity:** LOW (Detection), HIGH (Threat)  
**Date:** October 12, 2025  
**Owner:** Threat Intelligence & Malware Analysis Team  
**Proposer:** SSA

---

## Executive Summary

APT Malware Detection focuses on identifying known malware families used by Advanced Persistent Threat groups through signature-based and behaviour-based detection using EDR, antivirus, YARA scanning, and correlation with C2 infrastructure intelligence. This use case enables proactive detection of nation-state malware before significant damage occurs.

### Key Metrics
- **Detection Rate:** >98% for known APT malware
- **Mean Time to Detect (MTTD):** < 5 minutes
- **Mean Time to Isolate:** < 15 minutes
- **False Positive Rate:** < 1%

---

## 1. Use Case Objective

Detect malware and backdoors used by APT groups (e.g., SEASPY, SEASIDE, SALTWATER, SOGU, AngryRebel.Linux, HappyFuse, BIRDROBAT, DENSEDROP, DENSELAUNCH) through signature- and behaviour-based detection to enable rapid response and containment before lateral movement and data exfiltration occur.

---

## 2. Use Case Logical Flow

### Attack Expected Flow
1. **Initial Compromise:** APT malware delivered via phishing, exploit, or supply chain compromise
2. **Malware Execution:** Binary executes on victim endpoint (Windows or Linux)
3. **Persistence:** Malware establishes persistence (registry, scheduled task, service)
4. **Process Injection:** Injects into legitimate process (explorer.exe, svchost.exe) for stealth
5. **C2 Communication:** Establishes connection to command-and-control infrastructure
6. **Credential Harvesting:** Attempts to steal credentials (Mimikatz-like functionality)
7. **Lateral Movement:** Moves to additional systems within network
8. **Data Exfiltration:** Exfiltrates sensitive data via C2 channel

### Detection Flow
1. **Data Ingestion:** EDR and antivirus logs ingest into Splunk (index=edr, index=antivirus)
2. **Hash Matching:** Running process hashes compared against APT malware hash database
3. **YARA Scanning:** File system scanned with YARA rules for APT malware patterns
4. **Behavioral Analysis:** EDR detects suspicious behaviors (process injection, LSASS access)
5. **C2 Detection:** Network connections to known APT C2 domains/IPs
6. **Alert Triggering:** Splunk correlation rule triggers alert to SOC
7. **SOC Investigation:** Analyst reviews alert, confirms true positive
8. **Containment:** Isolate host via EDR, terminate malicious processes
9. **Forensics:** Memory dump and disk forensics to determine scope
10. **Remediation:** Remove malware, patch vulnerabilities, update detections

---

## 3. Correlation Rule

### Rule 1: Known APT Malware Hash Detection

```spl
index=edr (process_hash IN apt_malware_hashes OR process_name IN apt_malware_families)
| stats count by host, process_name, process_hash 
| where count>=1
| lookup threat_intel hash AS process_hash OUTPUT malware_family, apt_group
| eval severity="high"
| eval alert="APT Malware Detected: Known malware hash match"
| table _time, host, process_name, process_hash, malware_family, apt_group, alert
```

### Rule 2: YARA Rule Match Detection

```spl
index=yara_scans rule_match="true"
| stats count by host, file_path, yara_rule_name
| lookup apt_yara_rules rule_name AS yara_rule_name OUTPUT apt_family, severity
| eval alert="YARA Detection: APT malware pattern match"
| table _time, host, file_path, yara_rule_name, apt_family, severity, alert
```

### Rule 3: APT C2 Communication Detection

```spl
index=edr (dest_domain IN apt_c2_domains AND process_name IN suspicious_process_list)
| stats count by host, process_name, dest_domain
| lookup threat_intel domain AS dest_domain OUTPUT apt_group, c2_type
| where count>=1
| eval severity="high"
| eval alert="APT C2 Connection: Process connecting to known C2 infrastructure"
| table _time, host, process_name, dest_domain, apt_group, c2_type, alert
```

### Rule 4: Process Injection and Suspicious Behavior

```spl
index=edr event_type="process_injection" OR event_type="code_injection"
| where process_name NOT IN (whitelisted_processes)
| stats count by host, parent_process, target_process, technique
| eval severity="high"
| eval alert="Suspicious Behavior: Process injection technique detected"
| table _time, host, parent_process, target_process, technique, alert
```

---

## 4. Correlation Context Data Dependency

### Required Context Data
1. **APT Malware Hash Database:** SHA256 hashes of known APT malware families
2. **YARA Rules Repository:** Signature patterns for SEASPY, SALTWATER, AngryRebel.Linux, BIRDROBAT, etc.
3. **APT C2 Infrastructure Intelligence:** Domains, IPs, and network indicators associated with APT groups
4. **Host Classification:** Baseline of normal processes per host type (production vs. lab)
5. **Threat Intelligence Feeds:** Real-time updates from MISP, VirusTotal, Mandiant, Recorded Future

---

## 5. Data Collection Sources

### Primary Sources
- **EDR Logs:** CrowdStrike Falcon, SentinelOne, Microsoft Defender ATP
- **Antivirus Alerts:** Enterprise AV solutions (Symantec, McAfee, Trend Micro)
- **File Integrity Monitoring:** AIDE, Tripwire
- **YARA Scanning Results:** Continuous file system scanning
- **Threat Intelligence Feeds:** MISP, AlienVault OTX, Recorded Future

### Log Indices in Splunk
- `index=edr` - Endpoint Detection & Response logs
- `index=antivirus` - Antivirus detection events
- `index=yara_scans` - YARA rule matching results
- `index=threat_intel` - Threat intelligence IOCs

---

## 6. Data Fields to Extract

### Critical Fields
- `timestamp` - Event time
- `host_id` - Affected endpoint hostname/IP
- `process_name` - Executable name
- `process_hash` (SHA256) - File hash for IOC matching
- `parent_process` - Parent process for attribution
- `command_line` - Full command line arguments
- `dest_ip` / `dest_domain` - Network connection destination
- `user_id` - User context of execution
- `module_loaded` - DLLs loaded by process

---

## 7. Trigger Conditions

### Trigger on:
1. **Hash Match:** Execution of binary matching known APT malware signature
2. **YARA Rule Match:** File matching APT malware pattern (e.g., SEASPY strings, BIRDROBAT opcodes)
3. **Behavioral Detection:** Process exhibiting suspicious behavior:
   - Process injection into legitimate process
   - LSASS memory access (credential dumping)
   - Unusual network connections to C2 infrastructure
4. **C2 Communication:** Network connection to known APT C2 domain/IP

---

## 8. Suppress Parameter

### Suppression Rules
- Suppress duplicate alerts from same `host_id` and `process_hash` for **2 hours** to reduce alert fatigue
- Whitelist known safe hashes (e.g., legitimate admin tools that might match behavioral patterns)
- Exclude lab/sandbox environments from production alerting

---

## 9. Related Activity Report

### Scheduled Reports
- **Weekly APT Malware Detection Summary:** Distribution by malware family, affected hosts, correlation with ongoing campaigns
- **Monthly Threat Actor Activity Report:** APT group activity trends, new malware families observed
- **APT IOC Update Log:** Track when new IOCs are added to threat intel database

---

## 10. View and Visualizations

### Splunk Dashboards
1. **APT Malware Detection Overview:**
   - Table of detections sorted by severity
   - Bar chart by malware family (SEASPY, SALTWATER, AngryRebel.Linux, etc.)
   - Trend line showing detections over time
   - Network diagram of C2 destinations

2. **Host Risk Score:**
   - Heatmap showing endpoints with highest APT activity
   - Top 10 infected hosts

3. **C2 Infrastructure Tracking:**
   - Geographic map of C2 server locations
   - Timeline of C2 domain/IP observed activity

---

## 11. Escalations

### Escalation Path
1. **SOC Analyst (L1):** Initial triage and confirmation
2. **SOC Senior Analyst (L2):** Deep-dive investigation, host isolation
3. **Malware Analysis Team:** Reverse engineering of unknown samples
4. **Incident Response Team:** Containment and eradication coordination
5. **Patch Management Team:** Vulnerability remediation for exploited systems
6. **Vendor Coordination:** Engagement with security vendors for advanced analysis

---

## 12. Response Procedure

### Immediate Response (0-15 minutes)
1. **Host Isolation:** Isolate infected endpoint via EDR (network disconnect)
2. **Process Termination:** Kill malicious process and child processes
3. **Memory Capture:** Take memory dump for forensic analysis (Volatility)
4. **IOC Extraction:** Extract additional IOCs from infected system

### Investigation Phase (15 minutes - 4 hours)
1. **Forensic Analysis:** Analyze memory dump and disk artifacts
2. **Lateral Movement Check:** Hunt for indicators of lateral movement (PsExec, WMI, RDP)
3. **Credential Compromise Assessment:** Check for credential theft (LSASS dump, SAM database access)
4. **C2 Traffic Analysis:** Capture PCAP of C2 traffic for protocol analysis

### Remediation (4-24 hours)
1. **Malware Removal:** Remove malicious binaries, registry keys, scheduled tasks
2. **System Restoration:** Restore from clean backup or rebuild if necessary
3. **Patch Vulnerabilities:** Apply patches for exploited vulnerabilities
4. **Update Detections:** Add new IOCs to threat intel database, update YARA rules
5. **Share IOCs:** Share indicators with threat intelligence community (MISP)

### Post-Incident
1. **Lessons Learned:** Document attack vector, dwell time, effectiveness of detection
2. **Detection Improvement:** Refine detection rules to catch similar attacks earlier
3. **Awareness Training:** Update security awareness training based on attack TTPs

---

## 13. Noise / False Positives

### Expected Noise Level: **LOW**

### False Positive Scenarios
1. **Legitimate Admin Tools:** PowerShell, PsExec, WMI used by IT admins may trigger behavioral rules
   - **Mitigation:** Whitelist known admin accounts and approved tools
2. **Security Software:** Security tools may exhibit process injection behaviors
   - **Mitigation:** Whitelist known security software processes
3. **Lab/Sandbox Environments:** Deliberate malware analysis in isolated environments
   - **Mitigation:** Exclude lab networks from production alerting

---

## 14. Alert Severity

**MEDIUM** (for detection use case)  
**HIGH** (for actual threat impact)

### Severity Rationale
- Detection of **known** APT malware is medium-to-low false positive risk
- However, presence of APT malware indicates **HIGH** threat to organization
- Immediate containment required to prevent data exfiltration

---

## 15. Cyber Kill Chain Phase

**Phase 5: Installation**

### Kill Chain Coverage
- **Phase 1-4:** APT malware detection primarily occurs at Installation phase, after delivery and exploitation
- **Phase 6-7:** Detection also covers C2 (Command and Control) and Actions on Objective phases

---

## 16. MITRE ATT&CK Tactics & Techniques

### TA0002: Execution
- **T1204.002:** User Execution: Malicious File
- **T1059:** Command and Scripting Interpreter

### TA0003: Persistence
- **T1547:** Boot or Logon Autostart Execution
- **T1053:** Scheduled Task/Job

### TA0005: Defense Evasion
- **T1055:** Process Injection ‚ö†Ô∏è (Critical detection point)
- **T1027:** Obfuscated Files or Information
- **T1140:** Deobfuscate/Decode Files or Information

### TA0011: Command and Control
- **T1071:** Application Layer Protocol (HTTP/HTTPS)
- **T1090:** Proxy - Multi-hop infrastructure

---

## 17. APT Malware Families Database

### Tracked Malware Families

#### SEASPY (APT41 / Winnti)
- **Characteristics:** Backdoor malware targeting Windows, HTTP/HTTPS C2, credential harvesting
- **Detection Indicators:** SHA256 hashes, C2 domains: *.cdn-edge[.]com, Mutexes: Global\SEASPY_2024

#### AngryRebel.Linux
- **Characteristics:** Linux rootkit with kernel-mode components, process/file hiding, network backdoor
- **Detection Indicators:** Kernel module angryrebel.ko, hidden files in /tmp/.hidden/, TCP ports 7890-7899

#### BIRDROBAT (Russian APT)
- **Characteristics:** Modular malware framework, encrypted C2, lateral movement via WMI/PSExec
- **Detection Indicators:** Network beaconing every 120 seconds, C2 domains: *.update-cdn[.]net, process injection into explorer.exe

#### SALTWATER, SEASIDE, SOGU (APT41)
- **Characteristics:** Additional backdoors and implants from APT41 arsenal
- **Detection Indicators:** Similar C2 infrastructure to SEASPY, often deployed together

#### HappyFuse, DENSEDROP, DENSELAUNCH
- **Characteristics:** Advanced implants with anti-forensics and evasion capabilities
- **Detection Indicators:** Memory-only payloads, encrypted configuration blobs

---

## 18. Implementation Roadmap

### Immediate (0-30 days)
- ‚úÖ Deploy YARA rules for known APT families
- ‚úÖ Enable EDR on all critical systems
- ‚úÖ Import APT IOCs to threat intel platform (MISP)
- ‚úÖ Configure Splunk correlation rules

### Short-term (1-3 months)
- üîÑ Automated malware sandbox integration (Any.Run, Joe Sandbox)
- üîÑ Memory forensics capability (Volatility framework)
- üîÑ Threat hunting playbooks for each APT group
- üîÑ Regular APT IOC updates from intel feeds

### Long-term (3-12 months)
- üìã Machine learning behavioral detection models
- üìã Deception technology (honeypots, canary files)
- üìã Purple team exercises simulating APT TTPs
- üìã Automated IOC extraction and sharing with MISP community

---

## 19. Tooling & Technology Stack

### Detection Tools
- **CrowdStrike Falcon:** EDR with threat intel integration
- **YARA:** Pattern matching engine for malware identification
- **VirusTotal Intelligence:** Hash and behavioral lookups
- **Splunk ES:** SIEM correlation and alerting

### Analysis & Response
- **Any.Run / Joe Sandbox:** Automated malware analysis
- **Volatility:** Memory forensics framework
- **MISP:** Threat intelligence platform for IOC sharing
- **TheHive:** Incident response case management

---

## Appendix A: YARA Rule Example (SEASPY)

```yara
rule APT41_SEASPY_Backdoor
{
    meta:
        description = "Detects SEASPY backdoor used by APT41"
        author = "Threat Intel Team"
        date = "2024-10-01"
        malware_family = "SEASPY"
        apt_group = "APT41"
    
    strings:
        $s1 = "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" ascii
        $s2 = "cmd.exe /c" ascii
        $s3 = "Global\\SEASPY_" ascii
        $hex1 = { 4D 5A 90 00 03 00 00 00 }
    
    condition:
        uint16(0) == 0x5A4D and filesize < 500KB and 2 of ($s*) and $hex1
}
```

---

## Appendix B: Splunk Alert Configuration

### Alert Settings
- **Trigger Condition:** Number of Results > 0
- **Throttling:** 2 hours per host
- **Priority:** High
- **Notification:** Email to SOC, PagerDuty for critical hosts
- **Automated Actions:** 
  - Create ticket in ServiceNow
  - Trigger host isolation workflow via EDR API

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-10-12 | Threat Intel Team | Initial version |

**Next Review Date:** 2025-11-12  
**Owner:** Threat Intelligence & Malware Analysis Team  
**Contact:** threat-intel@company.com

---

*This document contains confidential information. Distribution restricted to authorized personnel only.*
